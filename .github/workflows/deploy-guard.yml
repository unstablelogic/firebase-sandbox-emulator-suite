name: ðŸ›¡ï¸ Deploy Guard

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force deployment even if schema check fails'
        required: false
        default: 'false'
        type: boolean

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§© Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ”¥ Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: ðŸ” Authenticate Firebase
        run: |
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase-service-account.json
            export GOOGLE_APPLICATION_CREDENTIALS=firebase-service-account.json
          else
            firebase login:ci --token "${{ secrets.FIREBASE_TOKEN }}"
          fi

      - name: ðŸ“¤ Export Schema
        run: |
          export FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          npm run schema:export

      - name: ðŸ” Compare Schema
        run: |
          npm run schema:diff
        continue-on-error: true

      - name: ðŸš« Block Deployment
        if: failure() && steps.schema-diff.outcome == 'failure' && github.event.inputs.force != 'true'
        run: |
          echo "âŒ Schema mismatch detected!"
          echo "Local schema differs from production schema."
          echo "To force deployment, use: gh workflow run deploy-guard.yml -f force=true"
          exit 1

      - name: âœ… Schema Check Passed
        if: success()
        run: |
          echo "âœ… Schema check passed!"
          echo "Deployment can proceed."

      - name: ðŸ“¢ Notify Success
        if: success()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"text":"âœ… Schema check passed for deployment"}'
          fi
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"content":"âœ… Schema check passed for deployment"}'
          fi

      - name: ðŸ“¢ Notify Failure
        if: failure() && steps.schema-diff.outcome == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"text":"âŒ Schema check failed - deployment blocked"}'
          fi
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"content":"âŒ Schema check failed - deployment blocked"}'
          fi

  deploy:
    needs: validate-schema
    runs-on: ubuntu-latest
    if: always() && (needs.validate-schema.result == 'success' || github.event.inputs.force == 'true')
    steps:
      - name: ðŸ§© Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸš€ Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase-service-account.json
            export GOOGLE_APPLICATION_CREDENTIALS=firebase-service-account.json
          else
            firebase login:ci --token "${{ secrets.FIREBASE_TOKEN }}"
          fi
          firebase deploy --only hosting

      - name: ðŸ“¢ Notify Deployment Success
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"text":"ðŸš€ Deployment successful!"}'
          fi
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"content":"ðŸš€ Deployment successful!"}'
          fi

